<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<title>TensorFlow.js: Age Estimator</title>
		<script src="assets/stats.min.js"></script>
		<script src="cam.js"></script>
		<script src="cam_age.js"></script>
		<script src="../pico.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.15.3/dist/tf.min.js"></script>
	</head>

	<script>
		var stats = new Stats();
		var initialized = false;

		async function button_callback() {
			if(initialized)
				return;
			var update_memory = pico.instantiate_detection_memory(5); // we will use the detecions of the last 5 frames
			var facefinder_classify_region = function(r, c, s, pixels, ldim) {return -1.0;};
			var cascadeurl = 'https://raw.githubusercontent.com/nenadmarkus/pico/c2e81f9d23cc11d1a612fd21e4f9de0921a5d0d9/rnt/cascades/facefinder';
			fetch(cascadeurl).then(function(response) {
				response.arrayBuffer().then(function(buffer) {
					var bytes = new Int8Array(buffer);
					facefinder_classify_region = pico.unpack_cascade(bytes);
				})
			})
			var ctx = document.getElementsByTagName('canvas')[0].getContext('2d');
			function rgba_to_grayscale(rgba, nrows, ncols) {
				var gray = new Uint8Array(nrows*ncols);
				for(var r=0; r<nrows; ++r)
					for(var c=0; c<ncols; ++c)
						// gray = 0.2*red + 0.7*green + 0.1*blue
						gray[r*ncols + c] = (2*rgba[r*4*ncols+4*c+0]+7*rgba[r*4*ncols+4*c+1]+1*rgba[r*4*ncols+4*c+2])/10;
				return gray;
			}
			var processfn = async function(video, dt) {
				// render the video frame to the canvas element and extract RGBA pixel data
				let start0 = (new Date()).getTime()
				ctx.drawImage(video, 0, 0);
				var rgba = ctx.getImageData(0, 0, 640, 480).data;
				// prepare input to `run_cascade`
				image = {
					"pixels": rgba_to_grayscale(rgba, 480, 640),
					"nrows": 480,
					"ncols": 640,
					"ldim": 640
				}
				params = {
					"shiftfactor": 0.1, // move the detection window by 10% of its size
					"minsize": 100,     // minimum size of a face
					"maxsize": 1000,    // maximum size of a face
					"scalefactor": 1.1  // for multiscale processing: resize the detection window by 10% when moving to the higher scale
				}
				dets = pico.run_cascade(image, facefinder_classify_region, params);
				dets = update_memory(dets);
				dets = pico.cluster_detections(dets, 0.2); // set IoU threshold to 0.2
				let end0 = (new Date()).getTime()
		    	let dettime0=end0-start0;

				let start1 = (new Date()).getTime()
				age_result = await runface (video , dets)
				let end1 = (new Date()).getTime()
		    	let dettime=end1-start1;
			    let msg ="Detection time:  ";
			    document.getElementById("agemodeltime").innerHTML = msg + dettime0 + "ms and Age model time " + dettime + "ms and Backend is: "  + tf.getBackend();

				for(i=0; i<dets.length; ++i)
					// check the detection score
					// if it's above the threshold, draw it
					// (the constant 50.0 is empirical: other cascades might require a different one)
					if(dets[i][3]>50.0)
					{
						ctx.lineWidth=3
						let x=dets[i][1]-dets[i][2]/2;
						let y=dets[i][0]-dets[i][2]/2;
						ctx.strokeStyle='red'
						ctx.strokeRect(x, y, dets[i][2], dets[i][2]);
						ctx.font = '25px serif';
						ctx.fillStyle = 'yellow';
						ctx.fillText(age_result.get(i, 0), x, y);
						console.log('i is:', i, age_result.get(i, 0));
					}
			}
			var mycamvas = new camvas(ctx, processfn);
			initialized = true;
		stats.showPanel( 0 );
		stats.dom.style.left = '10px';
		stats.dom.style.top = '200px';
		document.body.appendChild( stats.dom );
		}
	</script>

	<body>
		<h1 align="left"> Tensorflow.js for Age Estimator Model (Keras Pre-Trained)</h1>
		<p id="agemodeltime"></p>
		<p><left><input type="button" style="font-size : 20px;height:50px;width:120px; background-color: coral; color: blue"; value="WebCam" onclick="loadModel(); button_callback()"></left></p>
		<p><center><canvas  id="'canvas" width=640 height=480></canvas></center></p>
	</div>
	</body>

</html>
